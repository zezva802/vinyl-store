<!DOCTYPE html>
<html>
<head>
    <title>Stripe Test</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <h1>Stripe Payment Test</h1>

    <h2>Step 1: Config</h2>
    <p>JWT Token: <input type="text" id="jwtToken" size="80"></p>
    <p>Stripe Key: <input type="text" id="stripeKey" size="80"></p>
    <p>Vinyl ID: <input type="text" id="vinylId" size="80"></p>
    <button onclick="saveConfig()">Save</button>
    <p id="configMessage"></p>

    <hr>

    <h2>Step 2: Create Payment</h2>
    <button onclick="createPayment()">Create Payment Intent</button>
    <p id="paymentMessage"></p>

    <hr>

    <div id="paymentForm" style="display:none;">
        <h2>Step 3: Pay</h2>
        <p>Order ID: <span id="orderId"></span></p>
        <p>Amount: $<span id="amount"></span></p>
        <div id="card-element"></div>
        <br>
        <button onclick="completePayment()">Pay Now</button>
        <p id="completeMessage"></p>
    </div>

    <script>
        let config = {};
        let stripe = null;
        let cardElement = null;
        let clientSecret = '';
        let currentOrderId = '';

        function saveConfig() {
            config.jwtToken = document.getElementById('jwtToken').value;
            config.stripeKey = document.getElementById('stripeKey').value;
            config.vinylId = document.getElementById('vinylId').value;

            stripe = Stripe(config.stripeKey);
            cardElement = stripe.elements().create('card');
            cardElement.mount('#card-element');

            document.getElementById('configMessage').textContent = 'Saved!';
        }

        async function createPayment() {
            document.getElementById('paymentMessage').textContent = 'Creating...';

            const response = await fetch('http://localhost:3000/orders/create-payment-intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + config.jwtToken
                },
                body: JSON.stringify({ vinylId: config.vinylId })
            });

            const data = await response.json();

            if (response.ok) {
                clientSecret = data.clientSecret;
                currentOrderId = data.orderId;
                document.getElementById('orderId').textContent = data.orderId;
                document.getElementById('amount').textContent = (data.amount / 100).toFixed(2);
                document.getElementById('paymentForm').style.display = 'block';
                document.getElementById('paymentMessage').textContent = 'Created! Enter card below.';
            } else {
                document.getElementById('paymentMessage').textContent = 'Error: ' + data.message;
            }
        }

        async function completePayment() {
            document.getElementById('completeMessage').textContent = 'Processing...';

            const result = await stripe.confirmCardPayment(clientSecret, {
                payment_method: { card: cardElement }
            });

            if (result.error) {
                document.getElementById('completeMessage').textContent = 'Failed: ' + result.error.message;
            } else {
                document.getElementById('completeMessage').textContent = 'Success! Order: ' + currentOrderId;
                cardElement.clear();
            }
        }
    </script>
</body>
</html>